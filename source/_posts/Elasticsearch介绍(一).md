---
title: Elasticsearch介绍(一)
date: 2020-01-03 08:46:01
categories: [elasticseach]
toc: true
mathjax: true
tags:
  - elasticseach
  - 介绍
---



相比关系型数据库我们为什么选择Elasticsearch？Elasticsearch的优点在哪，

随后介绍elasticsearch和Lucene的原理。

<!-- more-->

## 为什么选择Elasticsearch

### 响应时间

在数据库做模糊查询时，如LIKE语句，它会遍历整张表，同时进行字符串匹配。例如，在查询“搜索”时，数据库会在每一条记录去匹配“搜索”这两字是否出现。实际上，并不是所有记录都包含“搜索”，所以做了很多无用功。这两个步骤都不高效，而且随着数据量的增大，消耗的资源和时间都会线性的增长。

![elasticsearch1](/images/elasticsearch1.png)

### 分词

在数据库查询“搜索技术”时，数据库通常只能把这四个字去进行全部匹配。可是在文本中，可能会出现“搜索用到哪些技术”，这时候就没有结果了。
 当使用Elasticsearch时进行搜索时，Elasticsearch能实现分词功能，例如当输入“搜索技术”时，Elasticsearch会自动做下面两件事，
 （1） 将“搜索技术”分词成“搜索”和“技术”
 （2） 查找包含这两个词的文档

### 相关性

在搜索时，如果出现多条结果，这时候哪一条记录是最相关的，比如baidu, google搜索引擎总是把你想要的结果放在最前面，但是数据库并不支持相关性搜索。
 Elasticsearch支持全文搜索和相关度评分。根据返回结果中检索词出现的频率等计算返回结果的相关性并由高到低排列。分数越高，意味着和查询语句越相关

### 可扩展性

容易扩展，支持PB级别的数据存储

**响应时间，分词功能，相关性排序，可扩展性是相比关系数据库选择Elasticsearch的几个因素**

## Elasticsearch的概述

### Elasticsearch的基本概念
Elasticsearch（ES）是一个基于Lucene构建的开源、分布式、RESTful接口的全文搜索引擎。Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据。可以在极短的时间内存储、搜索和分析大量的数据

### 集群（Cluster)
ES集群是一个或多个节点的集合，它们共同存储了整个数据集，并提供了联合索引以及可跨所有节点的搜索能力。多节点组成的集群拥有冗余能力，它可以在一个或几个节点出现故障时保证服务的整体可用性
### 节点(node)
一个节点是一个逻辑上独立的服务，可以存储数据，并参与集群的索引和搜索功能, 一个节点也有唯一的名字，群集通过节点名称进行管理和通信
### 主节点(Master)
主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点
### 数据节点(data)
该节点保存数据和执行数据相关 的操作，如增删改查，搜索，和聚合
### 客户端节点
一个节点的node.master和node.data都设置为false的时候，它既不能保持数据也不能成 为主节点，该节点可以作为客户端节点，可以响应用户的情况，并把相关操作发送到其他节点
### 索引（Index)
ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。类比传统的关系型数据库领域来说，索引相当于SQL中的一个数据库，或者一个数据存储方案(schema)。
### 文档类型（Type）
一个索引内部可定义一个或多个类型(type) ，类型相当于“表” ，(6.x以后只有_doc一个)
 文档（Document)
文档是Lucene索引和搜索的原子单位，基于JSON格式进行表示，相当于数据库的“记录”
映射(Mapping) 
相当于数据库中的schema，用来约束字段的类型，不过 Elasticsearch 的 mapping 可以自动根据数据创建
### 分片(shard) 
将一个索引内部的数据分布地存储于多个节点，每个分片其内部都是一个全功能且独立的索引，因此可由集群中的任何主机存储。创建索引时，用户可指定其分片的数量
### 副本(Replia)
为提高查询吞吐量或实现高可用性，可以使用分片副本,副本是一个分片的精确复制，每个分片可以有零个或多个副本。当主分片丢失时，集群将副本提升为新的主分片

![elasticsearch2](/images/elasticsearch2.png)

## Lucene的索引结构
### 索引(Index)：
在Lucene中一个索引是放在一个文件夹中的。
同一文件夹中的所有的文件构成一个Lucene索引。
### 段(Segment)：
一个索引可以包含多个段，段与段之间是独立的，添加新文档可以生成新的段，不同的段可以合并。
具有相同前缀文件的属同一个段
segments_N是段的元数据文件，也即它们保存了段的属性信息
### 文档(Document)：
文档是我们建索引的基本单位，不同的文档是保存在不同的段中的，一个段可以包含多篇文档。
新添加的文档是单独保存在一个新生成的段中，随着段的合并，不同的文档合并到同一个段中。
### 域(Field)：
一篇文档包含不同类型的信息，可以分开索引，比如标题，时间，正文，作者等，都可以保存在不同的域里
不同域的索引方式可以不同
### 词(Term)：
词是索引的最小单位，是经过词法分析和语言处理后的字符串。

## Lucene倒排索引原理
假设有两篇文章1和2 
文章1的内容为：Tom lives in Guangzhou, I live in Guangzhou too. 
文章2的内容为：He once lived in Shanghai. 

经过分词处理后 
文章1的所有关键词为：[tom] [live] [guangzhou] [i] [live] [guangzhou] 
文章2的所有关键词为：[he] [live] [shanghai] 
加上“出现频率”和“出现位置”信息后，我们的索引结构为：
![elasticsearch3](/images/elasticsearch3.png)

## 相似度计算
Elasticsearch 的相似度算法 被定义为检索词频率/反向文档频率， TF/IDF(term frequency/inverse document frequecy) ，包括以下内容：
### 检索词频率
检索词在该字段出现的频率？出现频率越高，相关性也越高。 字段中出现过 5 次要比只出现过 1 次的相关性高。
### 反向文档频率
每个检索词在索引中出现的频率？频率越高，相关性越低。检索词出现在多数文档中会比出现在少数文档中的权重更低。
### 字段长度准则
字段的长度是多少？长度越长，相关性越低。 检索词出现在一个短的 title 要比同样的词出现在一个长的 content 字段权重更大。

## 多词相关性的计算
我们把文档看作一系列词(Term)，每一个词(Term)都有一个权重(Term weight)，不同的词(Term)
根据自己在文档中的权重来影响文档相关性的打分计算。 于是我们把所有此文档中词(term)的权重(term weight) 看作一个向量。
![elasticsearch4](/images/elasticsearch4.png)







