---
title: 数据存储特点及选型
date: 2020-01-03 08:46:01
categories: [数据,存储]
toc: true
mathjax: true
tags:
  - 数据
  - 存储
---

介绍数据有哪些类型，数据存储有什么特点，数据存储的方式和模型。还探讨分布式存储的特点，分布式存储的方式，分区和副本的作用，分布式数据中数据倾斜问题，最后判断数据存储选型的依据及数据存储的未来。

<!-- more -->

## 数据类型

### 结构化数据
数据格式固定，存储有规律，一般指关系型数据库  
### 半结构化数据
半结构化数据是结构化数据的一种形式，它并不符合关系型数据库的数据模型结构，但包含相关标记，用来分隔语 义元素，也被称为自描述的结构，比如JSON/XML
### 非结构化数据
指不定长或无固定格式的数据，没有预定义的数据模型





## 数据存储系统的特点
### 可靠性（Reliability）
系统在困境（硬件故障、软件故障、人为错误）中仍可正常工作（正确完成功能，并能达到期望的性能水准）
### 可扩展性（Scalability）
有合理的办法应对系统的增长（数据量、流量、复杂性）
### 可维护性（Maintainability）
不同的人（工程师、运维）在不同的生命周期，都能在高效地在系统上工作
#### 可靠性是第一位的，为了保证可靠性，内存数据库redis也会将数据持久化到硬盘，关系型数据库、 ElasticSearch和hbase都用到了预写日志系统(Write-Ahead Logging), 将数据写入一份到日志(translog)，遇到断电等问题后可以通过日志来恢复数据。



## 数据存储的方式

文件,关系型数据库,关系型数据库(mysql,oracle, PostgresSQL),内存数据库 （redis),消息队列(RabbitMQ,ActiveMQ,Kafka),缓存(应用管理的缓存层,Memcached),全文搜索（Elasticsearch或Solr）,分布式存储(MongoDB,Hdfs, Hive,HBase）,图数据库(Neo4j)

![image-20200103085554756](/images/database_type.png)



## 数据存储的模型

### 无模型

### 键值模型

简单key-value模型，存储键和值，通过键查询，比如redis中的key，Hbase中的rowKey

### 文档模型(JSON/XML)

可以理解为多个键值模型的组合，适用于没有外部关联的数据数据，存储非常灵活，比如MongoDB中JSON文档 

   增加字段或删除字段(key)，文档模型(JSON/XML)查询方式也相对简单，在文档内查询即可

### 关系模型(SQL)

数据被组织成关系（SQL中称作表）,适应于一对一和简单多对多关系的存储，有模式有约束(需提前定义字段类型 

   ），结构化数据，数据存储有规律，查询方式更多，比如关系数据库中的各种复杂SQL语言，能实现复杂查询

### 图数据模型

用于复杂多对多关系

#### 从上至下，数据存储模型越复杂，约束越多，能实现的查询方式就更多，存储工具内的数据存储模型决定了其能实现的查询方式



## 用关系模型实现简历的存储

通过创建多个表(职位表，教育经历表…），每个表用user_id关联，通过user_id在职位表中获取职位信息

![biergaici](/images/biergaici.png)



## 用文档模型实现简历的存储 

JSON数据内包含有职位和教育经历，属于自包含文档，通过doc.positions的方式可以直接获取到数据，不需要关联查询

![biergaici2](/images/biergaici2.png)



## 分布式存储的特点

相比数据存储，大数据存储有其自己的特点，大数据存储一般是指多台机器存储，所以更专业的说法是分布式存储

### 可扩展性

前面数据存储说的可扩展性是指垂直扩展（选用更强的机器），分布式存储指的扩展是水平扩展（选用更多的机器）

### 容错/高可用性 

在单台机器出现故障的情况下仍然能继续工作，需要提供冗余。一台故障时，另一台可以接管数据

### 避免延迟 

数据存在多个副本的情况下，从中选取返回结果最快的副本



## 数据分布在多个节点上的两种方式

### 副本（Replication） 

在几个不同的节点上保存数据的相同副本，可能放在不同的位置。副本提供了冗余：如果一 些节点不可用，剩 余的节点仍然可以提供数据服务

### 分区 (Partitioning)

将一个大型数据集拆分成较小的子集（称为分区（partitions）），从而不同的分区可以指派 给不同的节点（node）（亦称分片（shard））

在不同存储软件中副本的概念是一样的，分区(partition)则有不同的说法：

Elasticsearch 为分片(shard) 、Kafka为分区(Partitioning) 、 Hbase为分区(Region) 、**Mongodb**为**分片****(**sharding) 、hdfs为分块(block大小默认是64M) 

分布式数据存储集群具有分区和副本的特点，通过副本解决容错/高可用问题

## 分区的作用

### 分区/分片后便于复制

相比复制一个大型数据集，分区分片之后数据更方便复制，不同副本可以同时复制到不同的节点上，扩展更容易

### 写入和查询负载分布在多个节点上

每个分区都是一个完整的支持写入和查询的单元，对于在单个分区上运行的查询，每个节点可以独立执行对自己的查询，因此可以通过添加更加更多的节点来扩大查询吞吐量.大型，复杂的查询也可以跨越多个节点并行处理

![kafka_partition](/images/kafka_partition.png)



## 分布式存储数据倾斜问题

也称数据热点问题，相比单机，数据存储在一个机器上，不会出现数据倾斜问题，当多台机器存储数据时 ，由于存在分区，如果设计不合理或操作有问题时就会遇到数据倾斜，导致单节点（倾斜节点）所存储数据量远大于其他节点。

ElasticSearch中新增节点时大量数据先入新节点，导致该节点扛不住压力，拖累整个集群的入库效率，解决办法是提前设置索引在每个节点上的分片数。

Hbase中的rowkey设计不合理会导致数据热点问题，写入的数据集中在一块，导致入库延时，解决办法是程序需要设计合理的rowkey

Kafka中可能由于生产者写入分区数据不均匀，导致数据倾斜，避免方式是kafka每个分区均衡写入



## 数据存储选型依据

### 数据模型

键值模型有redis,hbase,关系模型数据有关系型数据库(Mysql,Oracle,PostgreSQL),文档模型数据有MongDB,Elasticsearch

### 查询选择

数据存储的目的是为了查询，对查询的选择基本决定了数据存储选型。对查询基本不做要求(文件, Kafka), 根据

  键值查询(Redis,Hbase), 复杂的关联查询，比如JOIN(关系型数据库),大数据关联查询（Hive, 底层用mapreduce

  实现关联查询)全文检索(Elasticsearch,Solr)

### 数据大小

TB级以下的一般不用分片，保存在传统数据库中(关系型数据库，redis, MQ )，TB~PB级的数据就需要分片，分 

  布式存储数据库(Hadoop,Hbase, Elasticsearch)或者关系型数据库分表分库

### 数据存储在内存还是磁盘

   数据量小时且对查询速度要求高时可以选择内存数据库(redis) , 数据量大时就只能选择存储到磁盘的工具(Hbase)

## 数据存储的未来

### 跨界存储

随着存储软件的出现和功能扩展，存储越来越走向跨界，比如：数据存储可以被当成消息队列用（Redis中基于List的 LPUSH+BRPOP 实现队列），消息队列则带  

  有类似数据库的持久保证（Kafka,相比其它MQ消息队列数据存放内存，Kafka是存储在硬盘上，实现持久化），关系型数据库也可以存储文档模型(PostgresSQL中

  支持JSON类型数据的存储)，分布式协调组件zookeeper也可以存储数据

### 高效组合

相比以前一个项目用关系型数据库就能解决数据存储问题，大数据时代，架构越来越复杂，项目有各种要求，单个存储工具已不足以满足所有的数据存储需求。取

  而代之的是，需要各种存储工具的高效组合使用，并通过应用代码层面将它们缝合起来





